node {
    stage('Checkout') {
        // Make sure we have code in workspace
        checkout scm
    }

    stage('Detect Branch') {
        // Try Jenkins env first
        def branch = env.BRANCH_NAME

        if (!branch) {
            // Fallback to git
            branch = sh(returnStdout: true, script: "git rev-parse --abbrev-ref HEAD").trim()

            if (branch == "HEAD") {
                branch = sh(returnStdout: true, script: "git name-rev --name-only HEAD").trim()
            }
        }

        // Normalize branch name
        branch = branch.replaceFirst(/^remotes\/origin\//, '')

        echo "Environment - ${branch}"

        if (branch == "main") {
            echo "Deploying to PROD"
            // your prod deploy steps here
        } else {
            echo "Deploying to DEV"
            // your dev deploy steps here
        }
    }
}
